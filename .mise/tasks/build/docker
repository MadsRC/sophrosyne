#!/bin/sh
# mise sources=["dist/sophrosyne_linux_arm64", "dist/sophrosyne_linux_amd64"]
# mise outputs=["build/sophrosyne.tar"]
# mise depends=["build:dist"]

platform="linux/arm64,linux/amd64"

handle_argument() {
  echo "Argument '$1' not supported" >&2; exit 1
}

while test "$#" -gt 0; do
  case "$1" in
    -p) platform="$2"; shift 2;;

    --platform=*) platform="${1#*=}"; shift 1;;
    --platform) echo "$1 requires an argument" >&2; exit 1;;

    -*) echo "unknown option: $1" >&2; exit 1;;
    *) handle_argument "$1"; shift 1;;
  esac
done

mkdir -p build

docker buildx build --platform="$platform" -o type=oci,dest=build/sophrosyne.tar --tag sophrosyne:0.0.0 .

docker load -i build/sophrosyne.tar
